<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Climbing Logger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Climbing Logger" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      touch-action: manipulation;
      user-select: none;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .top-menu {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 6px;
      background: rgba(255, 255, 255, 0.95);
      text-align: center;
      display: none;
      font-family: sans-serif;
      z-index: 1100;
    }
    .top-menu button {
      margin: 0 10px;
    }
    .map-buttons {
      position: absolute;
      top: 45px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px;
      border-radius: 5px;
      font-family: sans-serif;
    }
    .map-buttons button,
    .map-buttons input,
    .map-buttons select {
      margin: 4px 2px;
    }
  </style>
</head>
<body>
  <div class="top-menu" id="contextMenu">
    <button onclick="editSelected()">‚úèÔ∏è Edit</button>
    <button onclick="removeSelected()">üóë Remove</button>
  </div>

  <div class="map-buttons">
    <select onchange="handleCragMenu(this.value)">
      <option value="">üßó Crag Menu</option>
      <option value="draw">‚ûï Draw Crag</option>
      <option value="select">üìç Select Crag</option>
      <option value="save">üíæ Save</option>
      <option value="load">üìÇ Load</option>
      <option value="export">‚¨á Export</option>
      <option value="import">‚¨Ü Import</option>
    </select>
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="importData(event)" />
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', { zoomControl: false }).setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a> contributors'
    }).addTo(map);

    let drawingCrag = false;
    let currentCragPoints = [];
    let cragLayers = [];
    let cragRoutes = {};
    let cragRouteMarkers = {};
    let selectedCrag = null;
    let selectedRouteIndex = null;
    const contextMenu = document.getElementById('contextMenu');

    function handleCragMenu(action) {
      if (action === 'draw') {
        drawingCrag = true;
        currentCragPoints = [];
        alert("Tap points to draw crag. Tap '‚úÖ Finish Crag' to complete.");
        showFinishButton(true);
      } else if (action === 'select') {
        alert("Tap a crag to select.");
        map.once('click', e => {
          let found = null;
          cragLayers.forEach(layer => {
            if (layer.getBounds().contains(e.latlng)) {
              found = layer.options.cragName;
            }
          });
          if (found) selectCrag(found);
        });
      } else if (action === 'save') {
        localStorage.setItem('climbLogger', JSON.stringify({ cragRoutes }));
        alert("Saved.");
      } else if (action === 'load') {
        const saved = localStorage.getItem('climbLogger');
        if (saved) {
          cragRoutes = JSON.parse(saved).cragRoutes || {};
          redrawRoutes();
          alert("Loaded.");
        }
      } else if (action === 'export') {
        const blob = new Blob([JSON.stringify({ cragRoutes })], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'climbing_logger.json';
        a.click();
      } else if (action === 'import') {
        document.getElementById('importFile').click();
      }
    }

    function showFinishButton(show) {
      let existing = document.getElementById('finishCragBtn');
      if (show && !existing) {
        const btn = document.createElement('button');
        btn.id = 'finishCragBtn';
        btn.textContent = '‚úÖ Finish Crag';
        btn.onclick = finishCragDrawing;
        document.querySelector('.map-buttons').appendChild(btn);
      } else if (!show && existing) {
        existing.remove();
      }
    }

    function finishCragDrawing() {
      if (currentCragPoints.length < 2) {
        alert("Need at least 2 points.");
        return;
      }
      const name = prompt("Name this crag:");
      if (!name) return;
      const poly = L.polyline(currentCragPoints, { color: 'brown', cragName: name }).addTo(map);
      poly.on('click', () => selectCrag(name));
      cragLayers.push(poly);
      cragRoutes[name] = [];
      cragRouteMarkers[name] = [];
      currentCragPoints = [];
      drawingCrag = false;
      showFinishButton(false);
    }

    function selectCrag(name) {
      selectedCrag = name;
      selectedRouteIndex = null;
      showContextMenu(true);
      redrawRoutes();
    }

    function redrawRoutes() {
      Object.keys(cragRouteMarkers).forEach(name => {
        cragRouteMarkers[name].forEach(m => map.removeLayer(m));
        cragRouteMarkers[name] = [];
      });

      if (!selectedCrag) return;

      (cragRoutes[selectedCrag] || []).forEach((r, i) => {
        const marker = L.marker(r.latlng, {
          draggable: true,
          icon: L.divIcon({ className: 'route-label', html: `<b>${i + 1}</b>`, iconSize: [24, 24] })
        }).addTo(map);

        marker.on('dragend', e => {
          cragRoutes[selectedCrag][i].latlng = e.target.getLatLng();
        });

        marker.on('click', () => {
          selectedRouteIndex = i;
          showContextMenu(true);
        });

        cragRouteMarkers[selectedCrag].push(marker);
      });
    }

    function showContextMenu(show) {
      contextMenu.style.display = show ? 'block' : 'none';
    }

    function editSelected() {
      if (selectedRouteIndex !== null && selectedCrag) {
        const r = cragRoutes[selectedCrag][selectedRouteIndex];
        r.name = prompt("Route name:", r.name) || r.name;
        r.grade = prompt("Grade:", r.grade) || r.grade;
        r.stars = parseInt(prompt("Stars (1‚Äì3):", r.stars)) || r.stars;
        r.comment = prompt("Comment:", r.comment) || r.comment;
        alert("Updated.");
      } else if (selectedCrag && selectedRouteIndex === null) {
        const newName = prompt("Rename crag:", selectedCrag);
        if (newName && newName !== selectedCrag) {
          cragRoutes[newName] = cragRoutes[selectedCrag];
          cragRouteMarkers[newName] = cragRouteMarkers[selectedCrag];
          delete cragRoutes[selectedCrag];
          delete cragRouteMarkers[selectedCrag];
          selectedCrag = newName;
          alert("Crag renamed.");
        }
      }
      redrawRoutes();
    }

    function removeSelected() {
      if (selectedRouteIndex !== null && selectedCrag) {
        cragRoutes[selectedCrag].splice(selectedRouteIndex, 1);
        selectedRouteIndex = null;
        redrawRoutes();
      } else if (selectedCrag) {
        cragRoutes[selectedCrag] = [];
        cragRouteMarkers[selectedCrag].forEach(m => map.removeLayer(m));
        cragRouteMarkers[selectedCrag] = [];
        selectedCrag = null;
        showContextMenu(false);
        alert("Crag removed (routes only).");
      }
    }

    map.on('click', e => {
      if (drawingCrag) {
        currentCragPoints.push(e.latlng);
        L.circleMarker(e.latlng, { radius: 5, color: 'blue', fillColor: 'blue', fillOpacity: 0.7 }).addTo(map);
        return;
      }

      if (selectedCrag && selectedRouteIndex === null) {
        const name = prompt("Route name:");
        if (!name) return;
        const grade = prompt("Grade:");
        const stars = parseInt(prompt("Stars (1‚Äì3):"), 10);
        const comment = prompt("Comment:");
        cragRoutes[selectedCrag].push({ name, grade, stars, comment, latlng: e.latlng });
        redrawRoutes();
      }
    });

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          cragRoutes = JSON.parse(e.target.result).cragRoutes || {};
          redrawRoutes();
          alert("Imported.");
        } catch (err) {
          alert("Error: " + err.message);
        }
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>
