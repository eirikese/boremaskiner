<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Climbing Logger</title>

  <!-- Fullscreen for iPhone Add to Home Screen -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Climbing Logger">
  <link rel="apple-touch-icon" href="icon.png">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #fff;
      font-family: sans-serif;
      overscroll-behavior: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .top-menu {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255,255,255,0.95);
      padding: 6px;
      text-align: center;
      z-index: 1100;
      display: none;
    }
    .top-menu span {
      font-weight: bold;
      margin-right: 10px;
    }
    .top-menu button {
      margin: 0 8px;
    }
    .map-buttons {
      position: absolute;
      top: 45px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      border-radius: 5px;
    }
    .map-buttons select, .map-buttons button, .map-buttons input {
      margin: 4px;
    }
  </style>
</head>
<body>
  <div class="top-menu" id="contextMenu">
    <span id="selectedTitle"></span>
    <button onclick="editSelected()">‚úèÔ∏è Edit</button>
    <button onclick="removeSelected()">üóë Remove</button>
    <button id="addRouteBtn" onclick="prepareAddRoute()" style="display:none">‚ûï Add Route</button>
  </div>

  <div class="map-buttons">
    <select onchange="handleMenu(this.value)">
      <option value="">üß∞ Menu</option>
      <option value="drawCrag">‚ûï Draw Crag</option>
      <option value="save">üíæ Save</option>
      <option value="load">üìÇ Load</option>
      <option value="export">‚¨á Export</option>
      <option value="import">‚¨Ü Import</option>
    </select>
    <input type="file" id="importFile" accept="application/json" style="display:none" onchange="doImport(event)">
    <input type="color" id="colorPicker" title="Pick route color" value="#f03">
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', { zoomControl: false }).setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '&copy; OpenTopoMap'
    }).addTo(map);

    let drawingCrag = false, tempPts = [];
    let crags = [], cragRoutes = {}, routeMarkers = {};
    let selectedCrag = null, selectedRoute = null, addRouteMode = false;

    const ctxMenu = document.getElementById('contextMenu');
    const titleEl = document.getElementById('selectedTitle');
    const addRouteBtn = document.getElementById('addRouteBtn');

    function handleMenu(val) {
      if (val === 'drawCrag') startCrag();
      else if (val === 'save') localStorage.setItem('climbLog', JSON.stringify({ crags, cragRoutes }));
      else if (val === 'load') load();
      else if (val === 'export') {
        const blob = new Blob([JSON.stringify({ crags, cragRoutes })], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'climbing_logger.json';
        a.click();
      }
      else if (val === 'import') document.getElementById('importFile').click();
      event.target.value = '';
    }

    function startCrag() {
      drawingCrag = true;
      tempPts = [];
      showFinishButton(true);
      alert("Tap to draw crag. Tap 'Finish Crag' to complete.");
    }

    function showFinishButton(show) {
      const existing = document.getElementById('finishCragBtn');
      if (show && !existing) {
        const btn = document.createElement('button');
        btn.id = 'finishCragBtn';
        btn.textContent = '‚úÖ Finish Crag';
        btn.onclick = finishCrag;
        document.querySelector('.map-buttons').appendChild(btn);
      } else if (!show && existing) existing.remove();
    }

    function finishCrag() {
      if (tempPts.length < 2) return alert("Need at least 2 points.");
      const name = prompt("Name this crag:"); if (!name) return;
      L.polyline(tempPts, { color: 'brown', weight: 4 }).addTo(map);
      L.polyline(tempPts, { color: 'transparent', weight: 30 }).on('click', () => selectCrag(name)).addTo(map);
      crags.push({ name, pts: tempPts });
      cragRoutes[name] = cragRoutes[name] || [];
      selectedCrag = name;
      drawingCrag = false;
      showFinishButton(false);
      showContextMenu(name);
    }

    function selectCrag(name) {
      deselectAll();
      selectedCrag = name;
      showContextMenu(name);
      redrawRoutes();
    }

    function prepareAddRoute() {
      addRouteMode = true;
      alert("Tap the map to place a route.");
    }

    function showContextMenu(name) {
      titleEl.textContent = `üßó ${name}`;
      ctxMenu.style.display = 'block';
      addRouteBtn.style.display = 'inline-block';
    }

    function deselectAll() {
      selectedCrag = null;
      selectedRoute = null;
      ctxMenu.style.display = 'none';
      addRouteBtn.style.display = 'none';
      Object.values(routeMarkers).flat().forEach(m => map.removeLayer(m));
    }

    function redrawRoutes() {
      Object.values(routeMarkers).flat().forEach(m => map.removeLayer(m));
      routeMarkers[selectedCrag] = [];
      if (!selectedCrag) return;
      cragRoutes[selectedCrag].forEach((r, i) => {
        const icon = L.divIcon({
          html: `<div style="font-size:20px;font-weight:bold;color:${r.color}">${i + 1}</div>`,
          iconSize: [32, 32], className: ''
        });
        const m = L.marker(r.latlng, { draggable: true, icon }).addTo(map);
        m.on('dragend', e => r.latlng = e.target.getLatLng());
        m.on('click', () => {
          selectedRoute = r;
          m.bindPopup(`<b>${r.name}</b><br>Grade: ${r.grade}<br>Stars: ${'‚òÖ'.repeat(r.stars)}<br>${r.comment}`).openPopup();
          showContextMenu(r.name);
        });
        routeMarkers[selectedCrag].push(m);
      });
    }

    map.on('click', e => {
      if (drawingCrag) {
        tempPts.push(e.latlng);
        L.circleMarker(e.latlng, { radius: 6, color: 'blue' }).addTo(map);
      } else if (addRouteMode && selectedCrag) {
        const name = prompt("Route name:"); if (!name) return;
        const grade = prompt("Grade:");
        const stars = parseInt(prompt("Stars (1‚Äì3):"), 10) || 0;
        const comment = prompt("Comment:");
        const color = document.getElementById('colorPicker').value;
        cragRoutes[selectedCrag].push({ name, grade, stars, comment, latlng: e.latlng, color });
        addRouteMode = false;
        redrawRoutes();
      } else {
        let inCrag = false;
        crags.forEach(c => {
          const poly = L.polyline(c.pts);
          if (poly.getBounds().contains(e.latlng)) inCrag = true;
        });
        if (!inCrag) deselectAll();
      }
    });

    function editSelected() {
      if (selectedRoute) {
        const r = selectedRoute;
        r.name = prompt("Name:", r.name) || r.name;
        r.grade = prompt("Grade:", r.grade) || r.grade;
        r.stars = parseInt(prompt("Stars (1‚Äì3):", r.stars)) || r.stars;
        r.comment = prompt("Comment:", r.comment) || r.comment;
        redrawRoutes();
      } else if (selectedCrag) {
        const newName = prompt("Rename crag:", selectedCrag);
        if (newName && newName !== selectedCrag) {
          cragRoutes[newName] = cragRoutes[selectedCrag];
          delete cragRoutes[selectedCrag];
          const crag = crags.find(c => c.name === selectedCrag);
          crag.name = newName;
          selectedCrag = newName;
        }
      }
    }

    function removeSelected() {
      if (selectedRoute && selectedCrag) {
        cragRoutes[selectedCrag] = cragRoutes[selectedCrag].filter(r => r !== selectedRoute);
        selectedRoute = null;
        redrawRoutes();
      } else if (selectedCrag) {
        cragRoutes[selectedCrag] = [];
        redrawRoutes();
        deselectAll();
      }
    }

    function doImport(event) {
      const file = event.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const data = JSON.parse(e.target.result);
        crags = data.crags || [];
        cragRoutes = data.cragRoutes || {};
        crags.forEach(c => {
          L.polyline(c.pts, { color: 'brown', weight: 4 }).addTo(map);
          L.polyline(c.pts, { color: 'transparent', weight: 30 }).on('click', () => selectCrag(c.name)).addTo(map);
        });
        redrawRoutes();
      };
      reader.readAsText(file);
    }

    function load() {
      const saved = localStorage.getItem('climbLog');
      if (saved) {
        const data = JSON.parse(saved);
        crags = data.crags || [];
        cragRoutes = data.cragRoutes || {};
        crags.forEach(c => {
          L.polyline(c.pts, { color: 'brown', weight: 4 }).addTo(map);
          L.polyline(c.pts, { color: 'transparent', weight: 30 }).on('click', () => selectCrag(c.name)).addTo(map);
        });
        redrawRoutes();
      }
    }

    load();
  </script>
</body>
</html>
